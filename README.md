# SensorFlow Firmware

![Linguagem](https://img.shields.io/badge/Linguagem-C-blue.svg)
![Plataforma](https://img.shields.io/badge/Plataforma-Raspberry%20Pi%20Pico%20W-green.svg)
![SDK](https://img.shields.io/badge/Pico%20SDK-2.1.1-orange.svg)
![Build](https://img.shields.io/badge/Build-Passing-brightgreen.svg)
![Licen√ßa](https://img.shields.io/badge/Licen%C3%A7a-MIT-yellow.svg)

Firmware modular para a placa Raspberry Pi Pico W projetado para ler dados de sensores de ambiente (temperatura, press√£o e humidade) e envi√°-los para um servidor remoto via **conex√£o Ethernet com fio**. Este projeto faz parte da solu√ß√£o SensorFlow e utiliza uma arquitetura modular com o m√≥dulo W5500 para comunica√ß√£o Ethernet est√°vel e confi√°vel.

---

## üìë √çndice

- [‚ö° Quick Start](#-quick-start)
- [üìú Vis√£o Geral](#-vis√£o-geral)
- [‚ú® Funcionalidades](#-funcionalidades)
- [üõ†Ô∏è Hardware Necess√°rio](#Ô∏è-hardware-necess√°rio)
- [üìã Especifica√ß√µes T√©cnicas](#-especifica√ß√µes-t√©cnicas)
- [üîå Esquema de Liga√ß√£o](#-esquema-de-liga√ß√£o)
- [‚öôÔ∏è Configura√ß√£o do Ambiente](#Ô∏è-configura√ß√£o-do-ambiente)
- [üöÄ Compilar e Enviar](#-compilar-e-enviar)
- [üì° API Reference](#-api-reference)
- [üêõ Debugging e Troubleshooting](#-debugging-e-troubleshooting)
- [üìÅ Estrutura do Projeto](#-estrutura-do-projeto)
- [üìÑ Licen√ßa](#-licen√ßa)

---

## ‚ö° Quick Start

Configura√ß√£o r√°pida em 5 minutos:

1. **Instale o ambiente**: VS Code + [Extens√£o Raspberry Pi Pico](https://marketplace.visualstudio.com/items?itemName=RaspberryPi.raspberry-pi-pico) + [Pico SDK](https://www.raspberrypi.com/documentation/microcontrollers/c_sdk.html)

2. **Clone e configure**:
   ```bash
   git clone https://github.com/jpaullopes/sensorflow-firmware.git
   cd sensorflow-firmware
   ```

3. **Crie o arquivo `secrets.cmake`** com configura√ß√µes de rede:
   ```cmake
   # Configura√ß√µes do Servidor de Destino
   set(TARGET_SERVER_IP "192.168.15.1")  # IP do seu servidor
   set(TARGET_PORT 8000)                 # Porta do seu servidor
   set(TARGET_PATH "/api/temperature_reading")  # Caminho da API
   set(API_KEY "SuaChaveAPI")             # Sua chave de API
   ```
4. **Conecte os sensores e m√≥dulo Ethernet** conforme [tabela de conex√µes](#-esquema-de-liga√ß√£o)

5. **Compile e envie**:
   - Abra no VS Code, pressione `Ctrl+Shift+P` ‚Üí `CMake: Build`
   - Coloque Pico W em modo BOOTSEL e arraste `build/main.uf2` para `RPI-RP2`

‚úÖ **Pronto!** Conecte cabo Ethernet e monitore via Serial para ver os logs de conex√£o e envio de dados.

---

## üìú Vis√£o Geral

O firmware inicializa os sensores, configura uma conex√£o Ethernet com fio atrav√©s do m√≥dulo W5500 e, em intervalos regulares, envia os dados coletados para uma API backend atrav√©s de requisi√ß√µes HTTP POST via TCP sockets. Cada dispositivo √© unicamente identificado pelo ID da placa. O c√≥digo foi organizado em m√≥dulos independentes para melhor organiza√ß√£o e reutiliza√ß√£o.

## ‚ú® Funcionalidades

- **Leitura de Sensores:**
  - Temperatura e Press√£o com o sensor **BMP280**.
  - Humidade com o sensor **AHT10**.
- **Conectividade:**
  - Conex√£o Ethernet com fio via m√≥dulo **W5500**.
  - Comunica√ß√£o TCP/IP direta com controle de sockets.
  - IP est√°tico configur√°vel via c√≥digo.
- **Envio de Dados:**
  - Constru√ß√£o de corpo de requisi√ß√£o em formato JSON.
  - Envio dos dados via m√©todo HTTP POST atrav√©s de sockets TCP.
  - Identifica√ß√£o √∫nica do dispositivo usando o ID da placa.
- **Arquitetura Modular:**
  - **Ethernet Manager**: Gerencia conex√£o Ethernet e inicializa√ß√£o do W5500.
  - **HTTP Client**: Gerencia requisi√ß√µes TCP/HTTP para o servidor via sockets diretos.
  - **Sensor Manager**: Centraliza a leitura de todos os sensores.
  - **Drivers de Sensores**: Drivers separados para BMP280 e AHT10.
  - **W5500 Config**: Interface SPI para comunica√ß√£o com o m√≥dulo Ethernet.

## üõ†Ô∏è Hardware Necess√°rio

- **Raspberry Pi Pico W** (RP2040 + CYW43439)
- **M√≥dulo Ethernet W5500** - Controlador Ethernet via SPI
- **Sensor BMP280** - Press√£o e Temperatura (I2C)
- **Sensor AHT10** - Umidade relativa (I2C)
- Fios jumper e protoboard para conex√µes
- Cabo Ethernet RJ45
- Cabo USB Micro-B para programa√ß√£o

### üìã Especifica√ß√µes T√©cnicas

| Componente | Especifica√ß√£o | Observa√ß√µes |
|------------|---------------|-------------|
| **Pico W** | 3.3V, ~100mA | Controlador principal RP2040 |
| **W5500** | 3.3V, ~150mA | Controlador Ethernet via SPI |
| **BMP280** | 1.8-3.6V, <1mA | Press√£o: 300-1100 hPa |
| **AHT10** | 2.0-5.5V, <1mA | Umidade: 0-100% RH |
| **Total** | 3.3V, ~252mA | Alimenta√ß√£o via USB ou externa |

### üîå Esquema de Liga√ß√£o

#### **M√≥dulo W5500 Ethernet (SPI0)**
| W5500 | Pino no Pico W | Fun√ß√£o |
| :--- | :--- | :--- |
| VCC | 3V3 (OUT) | Alimenta√ß√£o 3.3V |
| GND | GND | Terra |
| MISO | GP16 (SPI0_RX) | SPI Master In, Slave Out |
| MOSI | GP19 (SPI0_TX) | SPI Master Out, Slave In |
| SCK | GP18 (SPI0_SCK) | SPI Clock |
| CS | GP17 | Chip Select |
| RST | GP20 | Reset (opcional) |

#### **Sensores (I2C)**
| Sensor | Pino no Pico W | Fun√ß√£o |
| :--- | :--- | :--- |
| **BMP280 (I2C0)** | | |
| VCC | 3V3 (OUT) | Alimenta√ß√£o 3.3V |
| GND | GND | Terra |
| SCL | GP1 (I2C0_SCL) | Clock I2C |
| SDA | GP0 (I2C0_SDA) | Data I2C |
| **AHT10 (I2C1)** | | |
| VCC | 3V3 (OUT) | Alimenta√ß√£o 3.3V |
| GND | GND | Terra |
| SCL | GP3 (I2C1_SCL) | Clock I2C |
| SDA | GP2 (I2C1_SDA) | Data I2C |

#### **Configura√ß√£o de Rede**
- **IP Est√°tico**: 192.168.15.2
- **Gateway**: 192.168.15.1  
- **M√°scara**: 255.255.255.0
- **MAC Address**: 00:08:DC:11:22:33

## ‚öôÔ∏è Configura√ß√£o do Ambiente

Este projeto foi desenvolvido utilizando o SDK oficial do Raspberry Pi Pico e o Visual Studio Code.

### 1. Pr√©-requisitos

-   **VS Code**: Vers√£o 1.80+ com a extens√£o [Raspberry Pi Pico](https://marketplace.visualstudio.com/items?itemName=RaspberryPi.raspberry-pi-pico).
-   **Pico SDK**: Vers√£o 2.1.1+ - Siga o [guia oficial](https://www.raspberrypi.com/documentation/microcontrollers/c_sdk.html) para instalar o SDK, a toolchain ARM GCC e as outras depend√™ncias.
-   **CMake**: Vers√£o 3.13+ (normalmente inclu√≠do com o Pico SDK)
-   **Git**: Para clonar o reposit√≥rio

### 2. Configura√ß√£o do Projeto

1.  **Clone o reposit√≥rio:**
    ```bash
    git clone https://github.com/jpaullopes/sensorflow-firmware.git
    cd sensorflow-firmware
    ```

2. **Crie o arquivo de segredos:**
   O projeto utiliza um arquivo `secrets.cmake` para armazenar informa√ß√µes sens√≠veis como configura√ß√µes de rede e chaves de API. Este arquivo n√£o √© versionado pelo Git para sua seguran√ßa.

   - Crie o arquivo `secrets.cmake` na raiz do projeto e preencha com as suas informa√ß√µes:
        ```cmake
        # Configura√ß√µes do Servidor de Destino
        set(TARGET_SERVER_IP "192.168.15.1")  # IP do seu servidor
        set(TARGET_PORT 8000)                 # Porta do seu servidor
        set(TARGET_PATH "/api/temperature_reading")  # Caminho da API
        set(API_KEY "SUA_CHAVE_DE_API_SECRETA")      # Sua chave de API
        ```

   **‚ö†Ô∏è Importante**: As configura√ß√µes de rede Ethernet (IP do dispositivo, gateway, m√°scara) est√£o hard-coded no firmware. Para alter√°-las, edite o arquivo `inc/ethernet_manager/ethernet_manager.c`.

## üîß Desenvolvimento e Modifica√ß√£o

### Adicionando Novos Sensores

Para adicionar um novo sensor ao projeto:

1. **Crie um novo driver** em `inc/novo_sensor/`:
   ```c
   // inc/novo_sensor/novo_sensor.h
   void novo_sensor_init(void);
   float novo_sensor_read(void);
   ```

2. **Atualize o Sensor Manager**:
   ```c
   // inc/sensor_manager/sensor_manager.h
   typedef struct {
       float temperature_c;
       float humidity_percent;
       float pressure_hpa;
       float novo_valor;  // Adicione aqui
   } sensors_reading_t;
   ```

3. **Atualize o CMakeLists.txt**:
   ```cmake
   add_executable(main src/main.c
   inc/bmp280/bmp280.c
   inc/aht10/aht10.c
   inc/novo_sensor/novo_sensor.c  # Adicione aqui
   # ... outros arquivos
   ```

### Modificando a Comunica√ß√£o HTTP

Para alterar o formato JSON ou adicionar novos campos:

1. **Edite o HTTP Client** (`inc/http_client/http_client.c`):
   ```c
   // Modifique a fun√ß√£o callback_connected()
   snprintf(json_body, sizeof(json_body),
            "{\"temperature\":%.2f, \"humidity\":\"%.2f\", \"pressure\":\"%.2f\", \"sensor_id\":\"%s\", \"novo_campo\":\"valor\"}",
            // ... par√¢metros
   ```

2. **Atualize a estrutura `sensor_data_t`** se necess√°rio.

## üöÄ Compilar e Enviar

Com o ambiente e o projeto configurados, voc√™ pode compilar e enviar o firmware para a sua Pico W.

### M√©todo 1: Via VS Code (Recomendado)
1.  **Abra o projeto no VS Code.** A extens√£o do Raspberry Pi Pico deve detectar e configurar o projeto automaticamente.
2.  **Compile o projeto:**
    -   Pressione `Ctrl+Shift+P` e execute `CMake: Build`
    -   Ou pressione `F7` (se configurado)
3.  **Envie o firmware:**
    -   Coloque sua Pico W em modo `BOOTSEL` (segure o bot√£o BOOTSEL e conecte o cabo USB).
    -   Pressione `Shift+F5` para iniciar o upload (ou use a tarefa `Run Project`).
    -   Alternativamente, arraste o arquivo `build/main.uf2` para o drive `RPI-RP2` que aparece no seu computador.

### M√©todo 2: Via Terminal
```bash
# Configurar o build
cmake -B build

# Compilar
cmake --build build

# O arquivo main.uf2 estar√° em build/
# Arraste-o para o drive RPI-RP2 quando a Pico estiver em modo BOOTSEL
```

## üêõ Debugging e Troubleshooting

### Monitoramento via Serial

O firmware envia logs detalhados via USB Serial. Para monitorar:

1. **No VS Code**: Abra o terminal serial atrav√©s do menu `Terminal > New Terminal`
2. **Aplicativos externos**: Use qualquer terminal serial (PuTTY, Arduino Serial Monitor, etc.) na porta COM correspondente

### üìù Exemplo de Output Normal

```
====================================================
=     MONITOR DE SENSOR | RASPBERRY PI PICO W     =
=     ID √önico da Placa: e660c0e687254725         =
====================================================
[INFO] Inicializando Ethernet...
[INFO] Configurando m√≥dulo W5500...
[OK]   W5500 inicializado com sucesso!
[INFO] Configurando IP est√°tico: 192.168.15.2
[INFO] Gateway: 192.168.15.1 | M√°scara: 255.255.255.0
[OK]   Ethernet conectado com sucesso!
[INFO] Inicializando sensores...
[OK]   Sensor BMP280 inicializado.
[OK]   Sensor AHT10 inicializado.
[OK]   Sensores inicializados com sucesso.
[INFO] Iniciando ciclos de envio a cada 5 segundos.

[DADOS] Leitura dos sensores -> Temp: 23.45 C | Hum: 56.78 % | Pres: 1013.25 hPa

****************************************************
*           INICIANDO CICLO DE ENVIO               *
****************************************************
[INFO] Conectando via socket TCP ao servidor 192.168.15.1:8000...
[OK]   Socket TCP conectado com sucesso.
[DADOS] Preparando o seguinte JSON para envio:
       -> {"temperature":23.45, "humidity":56.78, "pressure":1013.25, "sensor_id":"e660c0e687254725"}
[INFO] Enviando requisi√ß√£o POST via socket...
[OK]   Requisi√ß√£o enviada. Aguardando resposta.
[INFO] Socket fechado.
[INFO] Ciclo de envio conclu√≠do.

Aguardando 5 segundos para o pr√≥ximo envio...
```

### Mensagens de Log Comuns

- `[INFO] Inicializando Ethernet...` - Iniciando configura√ß√£o Ethernet
- `[OK] W5500 inicializado com sucesso!` - M√≥dulo Ethernet configurado
- `[INFO] Configurando IP est√°tico: ...` - Configura√ß√£o de rede
- `[OK] Ethernet conectado com sucesso!` - Conex√£o Ethernet estabelecida
- `[DADOS] Leitura dos sensores -> ...` - Dados lidos dos sensores  
- `[INFO] Conectando via socket TCP...` - Iniciando conex√£o TCP
- `[OK] Socket TCP conectado com sucesso.` - Conex√£o TCP estabelecida
- `[OK] Requisi√ß√£o enviada. Aguardando resposta.` - Dados enviados com sucesso
- `[ERRO] ...` - Indica problemas que precisam ser investigados

### üìù Logs de Erro Comuns

- `[ERRO] Falha ao inicializar W5500.`
  - Verifique as conex√µes SPI com o m√≥dulo W5500.
  - Confirme se o m√≥dulo est√° alimentado (3.3V).
  - Verifique se o cabo Ethernet est√° conectado.

- `[ERRO] Sensor n√£o responde.`
  - Verifique as conex√µes I2C e a alimenta√ß√£o do sensor.
  - Confirme se o endere√ßo I2C do sensor est√° correto.

- `[ERRO] Falha na conex√£o TCP.`
  - Verifique a conectividade de rede com o servidor.
  - Confirme IP e porta no arquivo `secrets.cmake`.
  - Certifique-se de que o servidor est√° ativo e acess√≠vel.

### Problemas Comuns

**Ethernet n√£o conecta:**
- Verifique as conex√µes SPI com o W5500 (especialmente CS, SCK, MOSI, MISO)
- Confirme se o cabo Ethernet est√° conectado e funcionando
- Verifique se o switch/router est√° funcionando
- Teste a conectividade com um ping ao gateway (192.168.15.1)

**M√≥dulo W5500 n√£o responde:**
- Confirme alimenta√ß√£o 3.3V no W5500
- Verifique se o pino de reset (GP20) est√° funcionando
- Teste a comunica√ß√£o SPI com um oscilosc√≥pio
- Confirme se as defini√ß√µes de pinos no `w5500_config.c` est√£o corretas

**Sensores n√£o funcionam:**
- Verifique as conex√µes I2C
- Confirme se os sensores est√£o alimentados (3.3V)
- Teste a continuidade dos fios

**HTTP falha:**
- Verifique se o servidor est√° rodando
- Confirme IP e porta no `secrets.cmake`
- Teste a conectividade de rede
- Verifique se o servidor aceita requisi√ß√µes da rede local

## üìÅ Estrutura do Projeto

```
.
‚îú‚îÄ‚îÄ .vscode/                    # Configura√ß√µes do VS Code (tasks, launch, settings)
‚îú‚îÄ‚îÄ build/                      # Diret√≥rio dos arquivos de compila√ß√£o (gerado)
‚îú‚îÄ‚îÄ drivers/                    # Bibliotecas externas
‚îÇ   ‚îî‚îÄ‚îÄ ioLibrary_Driver/      # WIZnet ioLibrary para W5500 (baixada automaticamente)
‚îú‚îÄ‚îÄ inc/                        # Bibliotecas, drivers e m√≥dulos
‚îÇ   ‚îú‚îÄ‚îÄ aht10/                 # Driver do sensor de humidade AHT10
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ aht10.h
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ aht10.c
‚îÇ   ‚îú‚îÄ‚îÄ bmp280/                # Driver do sensor de temperatura/press√£o BMP280
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bmp280.h
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ bmp280.c
‚îÇ   ‚îú‚îÄ‚îÄ ethernet_manager/      # M√≥dulo de gerenciamento Ethernet
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ethernet_manager.h
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ethernet_manager.c
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ w5500_config.h
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ w5500_config.c
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ wizchip_macros.h
‚îÇ   ‚îú‚îÄ‚îÄ http_client/           # M√≥dulo cliente HTTP/TCP via sockets
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ http_client.h
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ http_client.c
‚îÇ   ‚îî‚îÄ‚îÄ sensor_manager/        # M√≥dulo de gerenciamento de sensores
‚îÇ       ‚îú‚îÄ‚îÄ sensor_manager.h
‚îÇ       ‚îî‚îÄ‚îÄ sensor_manager.c
‚îú‚îÄ‚îÄ src/                       # C√≥digo fonte principal
‚îÇ   ‚îî‚îÄ‚îÄ main.c                 # Arquivo principal da aplica√ß√£o
‚îú‚îÄ‚îÄ CMakeLists.txt             # Script de compila√ß√£o do CMake
‚îú‚îÄ‚îÄ lwipopts.h                 # Configura√ß√µes da pilha TCP/IP LwIP (legado)
‚îú‚îÄ‚îÄ secrets.cmake              # Arquivo de configura√ß√µes sens√≠veis (servidor, API)
‚îî‚îÄ‚îÄ README.md                  # Este arquivo
```

## üèóÔ∏è Arquitetura Modular

O firmware foi organizado em m√≥dulos independentes para facilitar manuten√ß√£o e expans√£o:

### üåê Ethernet Manager (`inc/ethernet_manager/`)

- **Responsabilidade**: Gerenciar conex√£o Ethernet e comunica√ß√£o com W5500
- **Fun√ß√µes principais**:
  - `ethernet_init()`: Inicializa SPI e configura W5500 com IP est√°tico
  - `ethernet_get_status()`: Verifica status da conex√£o Ethernet
  - `ethernet_cleanup()`: Limpa recursos e desconecta
- **Componentes**:
  - `w5500_config.c/h`: Interface SPI de baixo n√≠vel com W5500
  - `wizchip_macros.h`: Macros para mapeamento das fun√ß√µes ioLibrary

### üåê HTTP Client (`inc/http_client/`)

- **Responsabilidade**: Gerenciar comunica√ß√£o HTTP/TCP via sockets diretos
- **Fun√ß√µes principais**:
  - `http_send_sensor_data()`: Envia dados dos sensores via HTTP POST usando sockets TCP
- **Caracter√≠sticas**:
  - Comunica√ß√£o TCP direta sem callbacks ass√≠ncronos
  - Timeout de conex√£o configur√°vel
  - Constru√ß√£o manual de headers HTTP
  - Controle direto de sockets da ioLibrary

### üìä Sensor Manager (`inc/sensor_manager/`)

- **Responsabilidade**: Centralizar leitura de todos os sensores
- **Fun√ß√µes principais**:
  - `sensors_init()`: Inicializa todos os sensores
  - `sensors_read_all()`: L√™ dados de todos os sensores de uma vez
- **Vantagens**:
  - Interface unificada para m√∫ltiplos sensores
  - Tratamento centralizado de erros  
  - Estrutura de dados consolidada

### üîß Drivers de Sensores (`inc/aht10/`, `inc/bmp280/`)

- **Responsabilidade**: Interface direta com os sensores via I2C
- **Caracter√≠sticas**:
  - Drivers independentes e reutiliz√°veis
  - Calibra√ß√£o autom√°tica
  - Estruturas de dados espec√≠ficas para cada sensor

### ‚ö° W5500 Config (`inc/ethernet_manager/w5500_config.c`)

- **Responsabilidade**: Interface SPI para comunica√ß√£o com m√≥dulo W5500
- **Caracter√≠sticas**:
  - Fun√ß√µes callback para a ioLibrary WIZnet  
  - Controle de CS (Chip Select) e pinos SPI
  - Comunica√ß√£o SPI a 50MHz via spi0

## ‚ùì FAQ

### 1. O firmware n√£o conecta via Ethernet. O que fazer?

- Verifique as conex√µes SPI entre Pico W e W5500
- Confirme se o cabo Ethernet est√° conectado e funcionando
- Teste se o switch/router est√° acess√≠vel
- Verifique a alimenta√ß√£o do m√≥dulo W5500 (3.3V)

### 2. Os sensores n√£o est√£o funcionando. Como resolver?

- Confirme as conex√µes I2C e a alimenta√ß√£o dos sensores
- Teste a continuidade dos fios com um mult√≠metro

### 3. O servidor n√£o responde √†s requisi√ß√µes HTTP. O que verificar?

- Certifique-se de que o servidor est√° ativo e acess√≠vel na rede
- Verifique o IP, porta e caminho da API no arquivo `secrets.cmake`
- Teste a conectividade com o servidor usando ferramentas como `ping` ou `curl`

## üì° API Reference

### Exemplo de Requisi√ß√£o HTTP

```http
POST /api/temperature_reading HTTP/1.1
Host: 192.168.15.1:8000
Content-Type: application/json
API-Key: SuaChaveAPI

{
  "temperature": 23.45,
  "humidity": 56.78,
  "pressure": 1013.25,
  "sensor_id": "e660c0e687254725"
}
```

### Exemplo de Resposta Esperada

```json
{
  "status": "success",
  "message": "Dados recebidos com sucesso."
}
```

### Configura√ß√µes de Rede

O firmware est√° configurado com as seguintes configura√ß√µes de rede por padr√£o:

- **IP do Dispositivo**: 192.168.15.2
- **Gateway**: 192.168.15.1
- **M√°scara de Sub-rede**: 255.255.255.0
- **MAC Address**: 00:08:DC:11:22:33

Para alterar essas configura√ß√µes, edite o arquivo `inc/ethernet_manager/ethernet_manager.c`.

## üìÑ Licen√ßa

Este projeto est√° licenciado sob a licen√ßa MIT. Veja o texto completo da licen√ßa em [LICENSE](./LICENSE).
